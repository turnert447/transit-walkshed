<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Dissolve Population by Each Stop</title>
  <script src="https://unpkg.com/@turf/turf@6/turf.min.js"></script>
</head>
<body>

<h1>Dissolving Population by Stop…</h1>
<pre id="output">Processing…</pre>

<script>
const populationURL = "https://raw.githubusercontent.com/turnert447/transit-walkshed/main/assets/data/2020population.geojson";
const rrStopsURL     = "https://raw.githubusercontent.com/turnert447/transit-walkshed/main/assets/data/stops/RR_stops.geojson";
const linkStopsURL   = "https://raw.githubusercontent.com/turnert447/transit-walkshed/main/assets/data/lines/link_stops.geojson";

async function loadJSON(url) {
    const res = await fetch(url);
    return res.json();
}

async function main() {
    const population = await loadJSON(populationURL);
    const rrStops = await loadJSON(rrStopsURL);
    const linkStops = await loadJSON(linkStopsURL);

    const allStops = [...rrStops.features, ...linkStops.features];

    const outputFeatures = [];

    for (const stop of allStops) {
        // 1. Find population polygons that contain this stop
        const polysForThisStop = population.features.filter(poly =>
            turf.booleanPointInPolygon(stop, poly)
        );

        if (polysForThisStop.length === 0) continue;

        // 2. Convert to MultiPolygon
        const combined = turf.combine(turf.featureCollection(polysForThisStop));

        // 3. Dissolve MultiPolygon into a single shape
        const dissolved = turf.dissolve(combined);

        // 4. Add stop ID as metadata
        dissolved.properties = {
            stop_id: stop.properties.stop_id || null,
            stop_name: stop.properties.stop_name || null
        };

        outputFeatures.push(dissolved);
    }

    const finalGeoJSON = turf.featureCollection(outputFeatures);

    document.getElementById("output").textContent =
        JSON.stringify(finalGeoJSON, null, 2);
}

main();
</script>

</body>
</html>
